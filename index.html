<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MediaPipe + Goku + Giroscopio</title>
<style>
  html, body { margin:0; padding:0; height:100%; background:black; overflow:hidden; }
  #video, #overlayCanvas { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
  #overlayCanvas { pointer-events:none; }
  #status { position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px; color:white; }
</style>
</head>
<body>
<video id="video" autoplay playsinline></video>
<canvas id="overlayCanvas"></canvas>
<div id="status">Cargando...</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
(async () => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlayCanvas');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');

  const gokuImg = new Image();
  gokuImg.src = 'https://cdn.pixabay.com/photo/2024/08/12/goku-ai-generated.png'; // ejemplo libre

  // Variables para rotar Goku
  let gokuRotation = 0;
  window.addEventListener('deviceorientation', (event) => {
    // gamma es inclinación izquierda-derecha
    if (event.gamma !== null) {
      gokuRotation = event.gamma * (Math.PI / 180);
    }
  });

  // Cámara optimizada
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: 640, height: 480, facingMode: 'environment' },
      audio: false
    });
    video.srcObject = stream;
  } catch (e) {
    statusEl.textContent = 'Error cámara: ' + e.message;
    return;
  }

  function resizeCanvas(){
    canvas.width = video.videoWidth || window.innerWidth;
    canvas.height = video.videoHeight || window.innerHeight;
  }
  video.onloadedmetadata = resizeCanvas;
  window.onresize = resizeCanvas;

  // MediaPipe Hands
  const hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
  hands.setOptions({
    selfieMode: false,
    maxNumHands: 1,
    modelComplexity: 0,
    minDetectionConfidence: 0.3,
    minTrackingConfidence: 0.3
  });

  let handLandmarks = null;
  hands.onResults(results => {
    handLandmarks = results.multiHandLandmarks && results.multiHandLandmarks[0] || null;
    statusEl.textContent = handLandmarks ? 'Mano detectada' : 'No se detecta mano';
  });

  // Procesar menos frames (~15fps)
  let lastProcess = 0;
  async function processFrame(timestamp){
    if (timestamp - lastProcess > 66) {
      await hands.send({image: video});
      lastProcess = timestamp;
    }
    requestAnimationFrame(processFrame);
  }
  processFrame();

  // Dibujar
  function draw(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibujar landmarks si hay mano
    if (handLandmarks) {
      drawConnectors(ctx, handLandmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
      drawLandmarks(ctx, handLandmarks, {color: '#FF0000', lineWidth: 1});
    }

    // Dibujar Goku centrado y rotado según el teléfono
    if (gokuImg.complete) {
      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(gokuRotation);
      ctx.drawImage(gokuImg, -50, -75, 100, 150);
      ctx.restore();
    }

    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</body>
</html>
