<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MediaPipe Flecha + Mano - Corregido</title>
<style>
  html, body { margin:0; padding:0; background:black; overflow:hidden; height:100%; }
  canvas { display:block; width:100%; height:100%; }
  #status { position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:5px; color:white; }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="status">Cargando...</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<script>
(async () => {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');

  // Flecha base (esperamos que cargue)
  const arrowImg = new Image();
  arrowImg.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Red_Arrow_Up.svg/768px-Red_Arrow_Up.svg.png';

  let arrowReady = false;
  arrowImg.onload = () => {
    arrowReady = true;
  };
  arrowImg.onerror = () => {
    statusEl.textContent = 'Error cargando imagen de la flecha.';
  };

  // Giroscopio
  let gokuRotation = 0;
  window.addEventListener('deviceorientation', (event) => {
    if (event.gamma !== null) {
      gokuRotation = event.gamma * (Math.PI / 180);
    }
  });

  // Config c치mara
  const video = document.createElement('video');
  video.playsInline = true;
  video.autoplay = true;
  video.muted = true;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: 640, height: 480, facingMode: 'environment' }
    });
    video.srcObject = stream;
  } catch (e) {
    statusEl.textContent = 'Error c치mara: ' + e.message;
    return;
  }

  // Ajustar tama침o canvas
  function resize() {
    canvas.width = video.videoWidth || window.innerWidth;
    canvas.height = video.videoHeight || window.innerHeight;
  }
  video.onloadedmetadata = () => {
    resize();
    statusEl.textContent = 'C치mara lista, esperando mano...';
  };
  window.onresize = resize;

  // MediaPipe
  const hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
  hands.setOptions({
    selfieMode: false,
    maxNumHands: 1,
    modelComplexity: 0,
    minDetectionConfidence: 0.3,
    minTrackingConfidence: 0.3
  });

  let handLandmarks = null;
  hands.onResults(results => {
    handLandmarks = results.multiHandLandmarks && results.multiHandLandmarks[0] || null;
    statusEl.textContent = handLandmarks ? 'Mano detectada' : 'No se detecta mano';
  });

  // Procesar frames
  async function processFrame() {
    if (video.videoWidth > 0) {
      await hands.send({image: video});
    }
    requestAnimationFrame(processFrame);
  }
  processFrame();

  // Dibujar
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Video
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Mano
    if (handLandmarks) {
      drawConnectors(ctx, handLandmarks, HAND_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
      drawLandmarks(ctx, handLandmarks, {color: '#FF0000', lineWidth: 2});
    }

    // Flecha
    if (arrowReady) {
      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(gokuRotation);
      const size = 100;
      ctx.drawImage(arrowImg, -size/2, -size/2, size, size);
      ctx.restore();
    }

    requestAnimationFrame(draw);
  }
  draw();
})();
</script>
</body>
</html>
